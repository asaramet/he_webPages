<h2>CFX sbatch job on bwUniCluster using HE managed licenses.</h2>
<p>
  The script below, will start a CFX5 job on bwUniCluster,
  using ANSYS v.19.2, 4 nodes with 40 tasks each, totaling in 160 processors.
</p>
<p>This script can also be downloaded clicking the liks in the page footer.</p>
<p>
  The job in an CFX5 def file named <kbd>cfx_example.def</kbd> will be using Esslingen's university ANSYS license manager, with the host name
  <kbd>lizenz-ansys.hs-esslingen.de</kbd>.
</p>
<p>
  For cleanness let's assume a hypothetical HE user with an HE user id: <kbd>&ltHE_USER_ID&gt</kbd>
</p>
<p><pre>
#!/bin/bash
# Allocate one node
#SBATCH --nodes=4
# Number of program instances to be executed
#SBATCH --ntasks-per-node=40
# Queue class https://wiki.bwhpc.de/e/BwUniCluster_2.0_Batch_Queues
#SBATCH --partition=multiple
# Maximum run time of job
#SBATCH --time=8:00:00
# Give job a reasonable name
#SBATCH --job-name=cfx5-job
# File name for standard output (%j will be replaced by job id)
#SBATCH --output=fluent-test-%j.out
# File name for error output
#SBATCH --error=fluent-test-%j.err
# send an e-mail when a job begins, aborts or ends
#SBATCH --mail-type=ALL
# e-mail address specification
#SBATCH --mail-user=$ltHE_USER_ID&gt@hs-esslingen.de

echo "Starting at "
date

# load the software package
module load cae/ansys/19.2

HE_USER_ID=&ltHE_USER_ID&gt
CASE_NAME="cfx_example.def"
INPUT="${SLURM_SUBMIT_DIR}/${CASE_NAME}"

# start a SSH tunnel, creating a control socket.
DEAMON_PORT=49296
SOCKET_NAME="cfx-socket"
[[ -f ${SOCKET_NAME} ]] && rm -f ${SOCKET_NAME}
ssh -M -S ${SOCKET_NAME} -fnNT -L 2325:lizenz-ansys.hs-esslingen.de:2325 \
-L 1055:lizenz-ansys.hs-esslingen.de:1055 \
-L ${DEAMON_PORT}:lizenz-ansys.hs-esslingen.de:${DEAMON_PORT} \
${HE_USER_ID}@comserver.hs-esslingen.de

# export license environment variables
export ANSYSLMD_LICENSE_FILE=1055@localhost
export ANSYSLI_SERVERS=2325@localhost

# create hostslist
export jms_nodes=`srun hostname -s`
export hostslist=`echo $jms_nodes | sed "s/ /,/g"`

# set number of nodes variable
nrNodes=${SLURM_JOB_NUM_NODES}
echo "number of nodes: $nrNodes"

cfx5solve -batch -def $INPUT -par-host-list ${hostslist} -part ${nr_nodes} \
-start-method "Intel MPI Distributed Parallel"

# close the SSH control socket
ssh -S ${SOCKET_NAME} -O exit ${HE_USER_ID}@comserver.hs-esslingen.de

echo "Run completed at "
date
</pre></p>
